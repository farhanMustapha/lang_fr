<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice Practice Pro + AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Fix pour mobile - Hauteur dynamique */
        body {
            height: 100dvh; /* dvh = dynamic viewport height */
        }

        /* Animations */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .mic-active {
            animation: pulse-ring 1.5s infinite;
            background-color: #ef4444 !important;
        }

        /* Scrollbar masqu√©e */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .message-enter {
            animation: slideIn 0.3s ease-out forwards;
            opacity: 0;
            transform: translateY(10px);
        }
        @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }
        
        /* Loading dots */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
            fill: #6366f1;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Outil de traduction flottant */
        #translation-tooltip {
            transition: opacity 0.2s, transform 0.2s;
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col font-sans overflow-hidden text-slate-800">

    <!-- Header -->
    <header class="bg-white shadow-sm p-3 flex justify-between items-center z-30 shrink-0">
        <div class="flex items-center gap-2 cursor-pointer" onclick="showLibrary()">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white">
                <i class="fas fa-comment-dots"></i>
            </div>
            <div>
                <h1 class="font-bold text-base leading-tight">Voice Practice <span class="text-[10px] bg-gradient-to-r from-blue-500 to-purple-500 text-white px-1.5 py-0.5 rounded ml-1">AI</span></h1>
                <p class="text-[10px] text-gray-500" id="current-scenario-title">Menu Principal</p>
            </div>
        </div>
        <div class="flex gap-3">
             <button onclick="toggleSettings()" class="text-gray-400 hover:text-indigo-600 p-1 relative">
                <i class="fas fa-cog text-lg"></i>
                <span id="api-status-dot" class="absolute top-1 right-0 w-2 h-2 rounded-full bg-red-400 border border-white"></span>
            </button>
        </div>
    </header>

    <!-- VIEW: LIBRARY (Home Screen) -->
    <div id="view-library" class="flex-1 overflow-y-auto p-4 max-w-2xl mx-auto w-full">
        <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">Choisir une discussion</h2>
            <p class="text-gray-500 text-sm">S√©lectionnez un sc√©nario selon votre niveau</p>
        </div>
        
        <div class="bg-indigo-50 border border-indigo-100 p-3 rounded-lg mb-4 text-xs text-indigo-800 flex items-start gap-2">
            <i class="fas fa-magic mt-1"></i>
            <div>
                <strong>Astuce :</strong> Ajoutez votre cl√© API Google Gemini dans les param√®tres pour continuer la conversation librement apr√®s la fin du script !
            </div>
        </div>
        
        <div class="space-y-3" id="library-container">
            <!-- Cards will be injected here by JS -->
        </div>

        <button onclick="createNewScenario()" class="mt-6 w-full py-3 border-2 border-dashed border-gray-300 text-gray-500 rounded-xl hover:border-indigo-500 hover:text-indigo-600 transition flex items-center justify-center gap-2 font-medium">
            <i class="fas fa-plus"></i> Cr√©er ma propre discussion
        </button>
    </div>

    <!-- VIEW: CHAT (Hidden by default) -->
    <div id="view-chat" class="hidden flex-1 flex flex-col relative w-full max-w-2xl mx-auto h-full">
        
        <!-- Script Hint (Sticky) -->
        <div id="script-hint-container" class="hidden bg-amber-50 border-b border-amber-100 p-3 text-sm text-amber-900 flex justify-between items-center shrink-0 z-20 shadow-sm transition-all">
            <div class="flex-1 mr-2 overflow-hidden">
                <span class="font-bold text-amber-700 text-xs uppercase tracking-wide">C'est √† vous :</span>
                <p id="current-hint-text" class="italic font-medium text-lg leading-tight mt-1 truncate">...</p>
            </div>
            <button onclick="skipLine()" class="shrink-0 bg-white border border-amber-200 text-amber-700 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm active:bg-amber-100">
                Passer <i class="fas fa-forward ml-1"></i>
            </button>
        </div>

        <!-- AI Mode Indicator (Sticky when free mode) -->
        <div id="ai-mode-indicator" class="hidden bg-purple-600 text-white p-2 text-center text-xs font-bold shadow-md z-20 flex items-center justify-center gap-2">
            <i class="fas fa-sparkles"></i> Mode Conversation Libre (Gemini AI)
        </div>

        <!-- Chat Area -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-36 w-full">
            <!-- Messages go here -->
        </div>

        <!-- Floating Translation Tooltip -->
        <div id="translation-tooltip" class="fixed hidden bg-gray-900 text-white text-sm rounded px-3 py-2 z-50 shadow-xl flex items-center gap-2 -translate-x-1/2">
            <span id="selected-word-display" class="font-semibold text-yellow-300 max-w-[150px] truncate">...</span>
            <i class="fas fa-arrow-right text-gray-400 text-xs"></i>
            <span id="translation-result" class="font-bold font-serif" dir="rtl">...</span>
        </div>

        <!-- Controls (FIXED BOTTOM) -->
        <div class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-gray-100 via-gray-100/90 to-transparent z-40">
            <div class="max-w-2xl mx-auto flex items-center justify-center gap-6">
                
                <button onclick="resetConversation()" class="w-10 h-10 rounded-full bg-white text-gray-400 shadow hover:text-gray-600 flex items-center justify-center">
                    <i class="fas fa-redo"></i>
                </button>

                <!-- Big Mic Button -->
                <button id="mic-btn" onclick="toggleListening()" class="w-16 h-16 bg-indigo-600 text-white rounded-full shadow-lg shadow-indigo-200 flex items-center justify-center text-2xl active:scale-95 transition-all z-50 border-4 border-white">
                    <i class="fas fa-microphone"></i>
                </button>

                <button id="play-btn" onclick="startOrContinueScenario()" class="w-10 h-10 rounded-full bg-white text-green-500 shadow hover:text-green-600 flex items-center justify-center">
                    <i class="fas fa-play"></i>
                </button>
            </div>
            <div class="text-center mt-2 text-[10px] text-gray-400 font-medium">S√©lectionnez du texte pour traduire</div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[85vh] flex flex-col overflow-hidden">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                <h2 class="font-bold text-gray-800">Param√®tres</h2>
                <button onclick="toggleSettings()" class="w-8 h-8 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center hover:bg-gray-300"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-5 overflow-y-auto space-y-5">
                
                <!-- API Key Section -->
                <div class="bg-purple-50 border border-purple-100 p-4 rounded-xl">
                    <label class="text-xs font-bold text-purple-700 uppercase mb-2 block flex justify-between">
                        Google Gemini API Key
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-purple-500 underline lowercase font-normal">Obtenir une cl√© (Gratuit)</a>
                    </label>
                    <input type="password" id="api-key-input" placeholder="Collez votre cl√© ici (AI Studio)..." class="w-full border border-purple-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                    <p class="text-[10px] text-purple-600 mt-1">N√©cessaire pour le mode conversation libre illimit√©e.</p>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Voix de l'IA</label>
                    <select id="voice-select" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="">Chargement...</option>
                    </select>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Votre Langue (Reco)</label>
                    <select id="lang-select" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="en-US" selected>üá∫üá∏ Anglais (US)</option>
                        <option value="en-GB">üá¨üáß Anglais (UK)</option>
                        <option value="fr-FR">üá´üá∑ Fran√ßais</option>
                        <option value="ar-SA">üá∏üá¶ Arabe (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©)</option>
                        <option value="es-ES">üá™üá∏ Espagnol</option>
                    </select>
                </div>

                <!-- Custom Script Editor -->
                <div id="custom-script-area" class="hidden">
                    <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">√âditer le Script</label>
                    <textarea id="script-input" class="w-full h-40 border border-gray-200 rounded-xl p-3 text-sm font-mono bg-gray-50 focus:ring-2 focus:ring-indigo-500 outline-none resize-none" placeholder="AI: Hello&#10;Moi: Hi"></textarea>
                </div>
            </div>

            <div class="p-4 border-t bg-gray-50 flex justify-end">
                <button onclick="saveSettings()" class="bg-indigo-600 text-white px-6 py-2 rounded-xl hover:bg-indigo-700 font-semibold shadow-lg shadow-indigo-200 w-full">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // --- DATA & CONFIG ---
        const library = [
            {
                id: 'intro_en',
                title: 'Introduction Personnelle',
                desc: 'Apprendre √† se pr√©senter simplement.',
                level: 'D√©butant',
                levelColor: 'bg-green-100 text-green-700',
                lang: 'en-US',
                script: `AI: Hello! What is your name?
Moi: My name is Sarah. Nice to meet you.
AI: Nice to meet you too Sarah. Where are you from?
Moi: I am from Morocco. And you?
AI: I am a computer program, so I live on the internet!
Moi: That is funny. Are you ready to help me learn?
AI: Yes, I am ready. Let's start.`
            },
            {
                id: 'restaurant_en',
                title: 'Au Restaurant',
                desc: 'Commander un repas et une boisson.',
                level: 'Interm√©diaire',
                levelColor: 'bg-yellow-100 text-yellow-700',
                lang: 'en-US',
                script: `AI: Good evening. Do you have a reservation?
Moi: Yes, I have a table for two under the name Kamal.
AI: Perfect. Right this way. Here is the menu.
Moi: Thank you. What is the special today?
AI: Today we have grilled salmon with vegetables.
Moi: Sounds delicious. I will take that, please.`
            },
            {
                id: 'job_en',
                title: 'Job Interview',
                desc: 'Questions classiques d\'entretien.',
                level: 'Avanc√©',
                levelColor: 'bg-red-100 text-red-700',
                lang: 'en-US',
                script: `AI: Tell me about a challenge you faced at work.
Moi: Once, we had a tight deadline and a server crash.
AI: How did you handle that situation?
Moi: I stayed calm, communicated with the team, and fixed the bug.
AI: That shows good leadership. Do you prefer working alone or in a team?
Moi: I enjoy both, but I believe teamwork creates better results.`
            }
        ];

        let state = {
            currentScenario: null,
            scriptLines: [],
            currentIndex: 0,
            isListening: false,
            isSpeaking: false,
            recognition: null,
            voices: [],
            customMode: false,
            apiKey: '',
            freeMode: false,
            chatHistory: []
        };

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            // Load API Key
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                state.apiKey = savedKey;
                document.getElementById('api-key-input').value = savedKey;
                updateApiStatus(true);
            } else {
                updateApiStatus(false);
            }

            renderLibrary();
            initSpeechRecognition();
            initSpeechSynthesis();
            
            // Text selection listener for translation
            document.addEventListener('selectionchange', handleSelection);
            
            // Fix 100vh on mobile
            const setVh = () => {
                let vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            };
            window.addEventListener('resize', setVh);
            setVh();
        });

        function updateApiStatus(hasKey) {
            const dot = document.getElementById('api-status-dot');
            if (hasKey) {
                dot.classList.remove('bg-red-400');
                dot.classList.add('bg-green-500');
            } else {
                dot.classList.remove('bg-green-500');
                dot.classList.add('bg-red-400');
            }
        }

        // --- VIEW MANAGEMENT ---
        function renderLibrary() {
            const container = document.getElementById('library-container');
            container.innerHTML = '';
            
            library.forEach(item => {
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md hover:border-indigo-200 transition active:scale-[0.98]";
                card.onclick = () => loadScenario(item.id);
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-gray-800">${item.title}</h3>
                        <span class="text-[10px] px-2 py-1 rounded-full font-bold uppercase tracking-wider ${item.levelColor}">${item.level}</span>
                    </div>
                    <p class="text-sm text-gray-500">${item.desc}</p>
                    <div class="mt-3 flex items-center gap-2 text-xs text-gray-400">
                        <i class="fas fa-language"></i> ${item.lang === 'en-US' ? 'Anglais' : 'Autre'}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function showLibrary() {
            document.getElementById('view-chat').classList.add('hidden');
            document.getElementById('view-library').classList.remove('hidden');
            document.getElementById('current-scenario-title').innerText = "Menu Principal";
            state.isListening = false;
            window.speechSynthesis.cancel();
            if(state.recognition) state.recognition.stop();
        }

        function createNewScenario() {
            state.customMode = true;
            document.getElementById('script-input').value = ""; 
            document.getElementById('custom-script-area').classList.remove('hidden');
            toggleSettings();
        }

        function loadScenario(id) {
            const scenario = library.find(i => i.id === id);
            if (!scenario) return;

            state.currentScenario = scenario;
            state.customMode = false;
            state.freeMode = false;
            state.chatHistory = []; // Reset history
            
            // UI Update
            document.getElementById('view-library').classList.add('hidden');
            document.getElementById('view-chat').classList.remove('hidden');
            document.getElementById('current-scenario-title').innerText = scenario.title;
            document.getElementById('custom-script-area').classList.add('hidden');
            document.getElementById('lang-select').value = scenario.lang;
            document.getElementById('ai-mode-indicator').classList.add('hidden');
            document.getElementById('script-hint-container').classList.remove('hidden');

            // Load Script
            state.scriptLines = parseScript(scenario.script);
            state.currentIndex = 0;
            document.getElementById('chat-container').innerHTML = '';
            
            // Add Welcome
            addMessage('ai', "Ready? Press Play to start.", false);
        }

        // --- LOGIC ---
        function parseScript(rawText) {
            return rawText.split('\n')
                .filter(line => line.trim() !== '')
                .map(line => {
                    const sep = line.indexOf(':');
                    if (sep === -1) return null;
                    let role = line.substring(0, sep).trim().toLowerCase();
                    const text = line.substring(sep + 1).trim();
                    if (['moi', 'me', 'user', 'je'].includes(role)) role = 'user';
                    else role = 'ai';
                    return { role, text };
                }).filter(x => x);
        }

        function startOrContinueScenario() {
            // Check if scenario is finished
            if (state.currentIndex >= state.scriptLines.length) {
                // If we have an API key, switch to Free Mode
                if (state.apiKey && !state.freeMode) {
                    switchToFreeMode();
                } else if (!state.apiKey) {
                    addSystemMessage("üéâ Script termin√© ! Ajoutez une cl√© API pour continuer en mode libre.");
                }
                return;
            }

            const line = state.scriptLines[state.currentIndex];
            const hintBox = document.getElementById('script-hint-container');

            if (line.role === 'ai') {
                hintBox.classList.add('hidden');
                addMessage('ai', line.text);
                speak(line.text, () => {
                    state.currentIndex++;
                    setTimeout(startOrContinueScenario, 600);
                });
            } else {
                hintBox.classList.remove('hidden');
                document.getElementById('current-hint-text').innerText = line.text;
                addSystemMessage("üéôÔ∏è Appuyez sur le micro...");
            }
        }

        function switchToFreeMode() {
            state.freeMode = true;
            document.getElementById('script-hint-container').classList.add('hidden');
            document.getElementById('ai-mode-indicator').classList.remove('hidden');
            
            const transitionMsg = "That's the end of the script. Let's continue chatting! Ask me anything.";
            addMessage('ai', transitionMsg);
            speak(transitionMsg);
            
            // Build initial context for Gemini
            let scriptContext = state.scriptLines.map(l => `${l.role}: ${l.text}`).join('\n');
            state.chatHistory = [
                {
                    role: "user",
                    parts: [{ text: `You are a helpful language tutor roleplaying a scenario.
Scenario Context: ${state.currentScenario.desc}
The script we just finished:
${scriptContext}

Now continue the conversation naturally as the 'AI' character. Keep responses concise (1-2 sentences) and spoken-style. Correct me gently if I make big mistakes.` }]
                },
                {
                    role: "model",
                    parts: [{ text: transitionMsg }]
                }
            ];
        }

        async function handleUserSpeech(transcript) {
            // Display User Message
            addMessage('user', transcript);
            
            if (state.freeMode) {
                // --- FREE MODE LOGIC (GEMINI) ---
                if (!state.apiKey) return addSystemMessage("Erreur: Cl√© API manquante");

                // Add user msg to history
                state.chatHistory.push({ role: "user", parts: [{ text: transcript }] });

                // Show loading
                const loadingBubble = document.createElement('div');
                loadingBubble.className = "flex w-full mb-6 justify-start message-enter";
                loadingBubble.id = "ai-loading-bubble";
                loadingBubble.innerHTML = `
                    <div class="flex gap-2 max-w-[85%]">
                        <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex-shrink-0 flex items-center justify-center text-xs"><i class="fas fa-robot"></i></div>
                        <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm flex gap-1 items-center">
                            <svg class="w-8 h-2 typing-dot" viewBox="0 0 24 24"><circle cx="4" cy="12" r="3"/><circle cx="12" cy="12" r="3"/><circle cx="20" cy="12" r="3"/></svg>
                        </div>
                    </div>`;
                document.getElementById('chat-container').appendChild(loadingBubble);
                document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;

                try {
                    // Call Gemini API
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: state.chatHistory })
                    });
                    
                    const data = await response.json();
                    
                    // Remove loader
                    document.getElementById('ai-loading-bubble').remove();

                    if (data.candidates && data.candidates[0].content) {
                        const aiText = data.candidates[0].content.parts[0].text;
                        
                        // Add to UI & History
                        addMessage('ai', aiText);
                        state.chatHistory.push({ role: "model", parts: [{ text: aiText }] });
                        
                        // Speak
                        speak(aiText);
                    } else {
                        addSystemMessage("D√©sol√©, je n'ai pas compris.");
                    }

                } catch (error) {
                    document.getElementById('ai-loading-bubble').remove();
                    addSystemMessage("Erreur de connexion API.");
                    console.error(error);
                }

            } else {
                // --- SCRIPT MODE LOGIC ---
                state.currentIndex++;
                document.getElementById('script-hint-container').classList.add('hidden');
                setTimeout(startOrContinueScenario, 1000);
            }
        }

        function skipLine() {
             if (state.currentIndex < state.scriptLines.length) {
                const line = state.scriptLines[state.currentIndex];
                addMessage('user', line.text + " (‚è©)");
                state.currentIndex++;
                document.getElementById('script-hint-container').classList.add('hidden');
                setTimeout(startOrContinueScenario, 500);
            }
        }

        function resetConversation() {
            state.currentIndex = 0;
            state.freeMode = false;
            document.getElementById('chat-container').innerHTML = '';
            document.getElementById('ai-mode-indicator').classList.add('hidden');
            document.getElementById('script-hint-container').classList.remove('hidden');
            addMessage('ai', "On recommence !", false);
        }

        // --- SPEECH ---
        function initSpeechRecognition() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) return alert("Navigateur incompatible (Reconnaissance vocale)");
            
            state.recognition = new SR();
            state.recognition.continuous = false;
            state.recognition.interimResults = false;
            
            state.recognition.onstart = () => {
                state.isListening = true;
                document.getElementById('mic-btn').classList.add('mic-active');
            };
            state.recognition.onend = () => {
                state.isListening = false;
                document.getElementById('mic-btn').classList.remove('mic-active');
            };
            state.recognition.onresult = (e) => handleUserSpeech(e.results[0][0].transcript);
        }

        function toggleListening() {
            if (!state.recognition) return;
            if (state.isListening) state.recognition.stop();
            else {
                state.recognition.lang = document.getElementById('lang-select').value;
                state.recognition.start();
            }
        }

        function initSpeechSynthesis() {
            const load = () => {
                state.voices = window.speechSynthesis.getVoices();
                const sel = document.getElementById('voice-select');
                sel.innerHTML = '';
                state.voices.forEach((v, i) => {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.text = `${v.name.substring(0, 30)} (${v.lang})`;
                    if(v.lang.includes('en-US') && v.name.includes('Google')) opt.selected = true;
                    sel.appendChild(opt);
                });
            };
            load();
            window.speechSynthesis.onvoiceschanged = load;
        }

        function speak(text, cb) {
            if(state.isSpeaking) window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            const idx = document.getElementById('voice-select').value;
            if(state.voices[idx]) u.voice = state.voices[idx];
            u.rate = 0.9;
            u.onstart = () => state.isSpeaking = true;
            u.onend = () => { state.isSpeaking = false; if(cb) cb(); };
            window.speechSynthesis.speak(u);
        }

        // --- TRANSLATION MOCKUP ---
        const dictionary = {
            "hello": "ŸÖÿ±ÿ≠ÿ®ÿßŸã", "good morning": "ÿµÿ®ÿßÿ≠ ÿßŸÑÿÆŸäÿ±", "name": "ÿßÿ≥ŸÖ",
            "nice to meet you": "ÿ™ÿ¥ÿ±ŸÅŸÜÿß", "working": "ÿπŸÖŸÑ", "software": "ÿ®ÿ±ŸÖÿ¨Ÿäÿßÿ™",
            "challenge": "ÿ™ÿ≠ÿØŸä", "deadline": "ŸÖŸàÿπ ŸÜŸáÿßÿ¶Ÿä", "team": "ŸÅÿ±ŸäŸÇ",
            "reservation": "ÿ≠ÿ¨ÿ≤", "menu": "ŸÇÿßÿ¶ŸÖÿ© ÿ∑ÿπÿßŸÖ", "water": "ŸÖÿßÿ°", "food": "ÿ∑ÿπÿßŸÖ"
        };

        function handleSelection() {
            const selection = window.getSelection();
            const text = selection.toString().trim().toLowerCase();
            const tooltip = document.getElementById('translation-tooltip');

            if (!text || text.length < 2) {
                tooltip.classList.add('hidden');
                return;
            }
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            let translated = dictionary[text];
            if (!translated) {
                 translated = `<a href="https://translate.google.com/?sl=auto&tl=ar&text=${encodeURIComponent(text)}" target="_blank" class="underline text-yellow-300">Google Translate</a>`;
            }
            document.getElementById('selected-word-display').innerText = text;
            document.getElementById('translation-result').innerHTML = translated;
            tooltip.style.top = `${rect.top - 50}px`;
            tooltip.style.left = `${rect.left + (rect.width / 2)}px`;
            tooltip.classList.remove('hidden');
        }

        // --- UTILS ---
        function addMessage(role, text, animate=true) {
            const div = document.createElement('div');
            const isUser = role === 'user';
            div.className = `flex w-full mb-6 ${isUser ? 'justify-end' : 'justify-start'} ${animate ? 'message-enter' : ''}`;
            const bg = isUser ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white text-gray-800 border border-gray-100 shadow-sm rounded-bl-none';
            
            div.innerHTML = `
                <div class="flex gap-2 max-w-[85%] ${isUser ? 'flex-row-reverse' : ''}">
                    <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-xs ${isUser ? 'bg-indigo-800 text-white' : 'bg-indigo-100 text-indigo-600'}">
                        <i class="fas ${isUser ? 'fa-user' : 'fa-robot'}"></i>
                    </div>
                    <div class="${bg} p-3.5 rounded-2xl text-base leading-relaxed break-words shadow-sm">
                        ${text}
                    </div>
                </div>`;
            
            document.getElementById('chat-container').appendChild(div);
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }

        function addSystemMessage(text) {
            const div = document.createElement('div');
            div.className = "text-center text-[10px] text-gray-400 my-3 font-medium uppercase tracking-widest";
            div.innerText = text;
            const c = document.getElementById('chat-container');
            c.appendChild(div);
            c.scrollTop = c.scrollHeight;
        }

        function toggleSettings() {
            document.getElementById('settings-modal').classList.toggle('hidden');
        }

        function saveSettings() {
            // Save API Key
            const keyInput = document.getElementById('api-key-input').value.trim();
            if (keyInput) {
                state.apiKey = keyInput;
                localStorage.setItem('gemini_api_key', keyInput);
                updateApiStatus(true);
            } else {
                state.apiKey = '';
                localStorage.removeItem('gemini_api_key');
                updateApiStatus(false);
            }

            // Save Custom Script
            if (state.customMode) {
                const text = document.getElementById('script-input').value;
                if (!text.trim()) return alert("Le script est vide !");
                state.scriptLines = parseScript(text);
                state.currentScenario = { title: 'Discussion Personnalis√©e', lang: document.getElementById('lang-select').value };
                document.getElementById('view-library').classList.add('hidden');
                document.getElementById('view-chat').classList.remove('hidden');
                document.getElementById('current-scenario-title').innerText = "Personnalis√©";
                document.getElementById('custom-script-area').classList.add('hidden');
                
                document.getElementById('chat-container').innerHTML = '';
                addMessage('ai', "Script charg√©. Pr√™t ?", false);
                state.currentIndex = 0;
            }
            toggleSettings();
        }

    </script>
</body>
</html>